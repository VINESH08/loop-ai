<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindCare AI - Hospital Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: #f5f7fb;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            height: 60px;
        }
        .brand {
            font-size: 1.3rem;
            font-weight: 700;
            color: #5b4cdb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-name { font-weight: 500; color: #444; font-size: 0.9rem; }
        .user-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #5b4cdb;
        }
        .btn-out {
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
        }
        .btn-out:hover { background: #f5f5f5; }

        /* ========== INITIAL STATE ========== */
        .initial-view {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .initial-view h2 {
            color: #333;
            font-weight: 600;
            font-size: 1.8rem;
        }
        .initial-view p {
            color: #888;
            font-size: 1rem;
        }
        .big-mic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #5b4cdb, #7c3aed);
            color: white;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(91, 76, 219, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .big-mic:hover {
            transform: scale(1.08);
            box-shadow: 0 15px 50px rgba(91, 76, 219, 0.5);
        }
        .big-mic:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* ========== CHAT STATE ========== */
        .chat-view {
            height: calc(100vh - 60px);
            display: none;
            justify-content: center;
            padding: 15px;
        }
        .chat-view.active {
            display: flex;
        }
        .initial-view.hidden {
            display: none;
        }

        .chat-box {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, #5b4cdb 0%, #7c3aed 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .header-text h5 { margin: 0; font-weight: 600; font-size: 1.1rem; }
        .header-text p { margin: 0; font-size: 0.8rem; opacity: 0.85; }

        /* Messages */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafbfc;
        }
        .msg-row {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            align-items: flex-end;
        }
        .msg-row.user { flex-direction: row-reverse; }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .avatar.bot {
            background: linear-gradient(135deg, #5b4cdb, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        .avatar.user-av img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .msg-content { max-width: 70%; }
        .msg-name {
            font-size: 0.7rem;
            color: #999;
            margin-bottom: 3px;
            font-weight: 500;
        }
        .msg-row.user .msg-name { text-align: right; }
        
        .bubble {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.9rem;
            line-height: 1.45;
        }
        .msg-row.bot .bubble {
            background: white;
            color: #333;
            border: 1px solid #eee;
            border-bottom-left-radius: 4px;
        }
        .msg-row.user .bubble {
            background: linear-gradient(135deg, #5b4cdb, #7c3aed);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .msg-time {
            font-size: 0.65rem;
            color: #aaa;
            margin-top: 4px;
            font-style: italic;
        }

        /* Mic Bar */
        .mic-bar {
            padding: 14px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .mic-btn {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(34,197,94,0.4);
        }
        .mic-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .mic-btn:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }
        .mic-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239,68,68,0.4);
            animation: pulse 1.2s infinite;
        }
        .mic-btn.processing {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 15px rgba(245,158,11,0.4);
        }
        .mic-btn.forwarded {
            background: #9ca3af;
            box-shadow: none;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
            50% { box-shadow: 0 0 0 12px rgba(239,68,68,0); }
        }
        .mic-status {
            font-size: 0.85rem;
            color: #666;
            min-width: 100px;
        }

        /* Scrollbar */
        .messages::-webkit-scrollbar { width: 5px; }
        .messages::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="brand">
            <i class="bi bi-hospital"></i> FindCare AI
        </div>
        <div class="user-info">
            <span class="user-name" id="userName">Loading...</span>
            <img id="userPic" class="user-pic" src="" style="display:none;">
            <button class="btn-out" id="logoutBtn">Sign Out</button>
        </div>
    </div>

    <!-- Initial View: Large Centered Mic -->
    <div class="initial-view" id="initialView">
        <h2>Hospital Network Assistant</h2>
        <p>Tap the microphone to start a conversation</p>
        <button class="big-mic" id="bigMicBtn" disabled>
            <i class="bi bi-mic-fill"></i>
        </button>
        <p id="initStatus" style="color: #888; font-size: 0.9rem;">Initializing...</p>
    </div>

    <!-- Chat View: Shows after first interaction -->
    <div class="chat-view" id="chatView">
        <div class="chat-box">
            <!-- Header -->
            <div class="chat-header">
                <div class="header-icon"><i class="bi bi-headset"></i></div>
                <div class="header-text">
                    <h5>Hospital Network Assistant</h5>
                    <p>Ask about hospitals in your network</p>
                </div>
            </div>

            <!-- Messages -->
            <div class="messages" id="messages"></div>

            <!-- Mic Bar -->
            <div class="mic-bar">
                <span class="mic-status" id="status">Tap to speak</span>
                <button class="mic-btn" id="micBtn">
                    <i class="bi bi-mic-fill" id="micIcon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999;">
        <div class="toast align-items-center text-bg-danger" id="toast" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastMsg"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <audio id="audio" style="display:none;"></audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = 'http://localhost:8080';
        const bigMicBtn = document.getElementById('bigMicBtn');
        const initialView = document.getElementById('initialView');
        const chatView = document.getElementById('chatView');
        const micBtn = document.getElementById('micBtn');
        const micIcon = document.getElementById('micIcon');
        const status = document.getElementById('status');
        const initStatus = document.getElementById('initStatus');
        const messages = document.getElementById('messages');
        const audio = document.getElementById('audio');
        const toast = new bootstrap.Toast(document.getElementById('toast'));

        let user = { name: 'You', pic: null };
        let introAudio = null;
        let introText = "Hi, this is FindCare AI. How can I assist you today?";
        let recorder, chunks = [], recording = false, processing = false, forwarded = false;
        let chatStarted = false;

        // Fetch intro audio from backend (uses same ElevenLabs voice as responses)
        async function loadIntroAudio() {
            try {
                const response = await fetch(`${API}/api/voice/intro`, { credentials: 'include' });
                if (response.ok) {
                    const blob = await response.blob();
                    introAudio = new Audio(URL.createObjectURL(blob));
                    // Get intro text from header if available
                    const headerText = response.headers.get('X-Intro-Text');
                    if (headerText) introText = headerText;
                    console.log('Intro audio loaded from backend');
                }
            } catch (e) {
                console.log('Using fallback intro.mp3');
                introAudio = new Audio('intro.mp3');
            }
        }

        // Switch to chat view
        function showChatView() {
            initialView.classList.add('hidden');
            chatView.classList.add('active');
            chatStarted = true;
        }

        async function playIntro() {
            addMsg(introText, 'bot');
            if (introAudio) {
                await new Promise(r => { introAudio.play(); introAudio.onended = r; });
            }
        }

        async function initMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                recorder.ondataavailable = e => e.data.size > 0 && chunks.push(e.data);
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    chunks = [];
                    await process(blob);
                };
                bigMicBtn.disabled = false;
                initStatus.textContent = 'Ready! Tap to start';
            } catch (e) {
                initStatus.textContent = 'Microphone not available';
            }
        }

        // Big mic click - starts the experience
        bigMicBtn.addEventListener('click', async () => {
            bigMicBtn.disabled = true;
            initStatus.textContent = 'Starting...';
            
            // Switch to chat view
            showChatView();
            
            // Play intro
            status.textContent = 'FindCare AI speaking...';
            await playIntro();
            
            // Start recording
            startRecording();
        });

        // Small mic click - toggle recording
        micBtn.addEventListener('click', () => {
            if (processing || forwarded) return;
            recording ? stopRecording() : startRecording();
        });

        function startRecording() {
            chunks = [];
            recorder.start();
            recording = true;
            updateUI();
        }

        function stopRecording() {
            recorder.stop();
            recording = false;
            processing = true;
            updateUI();
        }

        async function process(blob) {
            try {
                status.textContent = 'Processing...';
                const fd = new FormData();
                fd.append('audio', blob, 'rec.webm');

                const res = await fetch(`${API}/api/voice/conversation`, {
                    method: 'POST',
                    credentials: 'include',
                    body: fd
                });

                if (!res.ok) throw new Error('Failed');

                const t = res.headers.get('X-Transcript');
                const r = res.headers.get('X-Response-Text');
                const timeTaken = res.headers.get('X-Time-Taken'); // Time in ms

                if (t) addMsg(t, 'user');
                if (r) {
                    // Convert ms to seconds for display
                    const timeInSec = timeTaken ? (parseInt(timeTaken) / 1000).toFixed(1) : null;
                    addMsg(r, 'bot', timeInSec);
                    if (r.toLowerCase().includes('forwarding') && r.toLowerCase().includes('human')) {
                        forwarded = true;
                        micBtn.disabled = true;
                        micBtn.classList.add('forwarded');
                        status.textContent = 'Forwarded to agent';
                    }
                }

                const audioBlob = await res.blob();
                playAudio(audioBlob);

            } catch (e) {
                showErr(e.message);
            } finally {
                processing = false;
                if (!forwarded) updateUI();
            }
        }

        function addMsg(text, type, timeSec = null) {
            const row = document.createElement('div');
            row.className = `msg-row ${type}`;

            let av = type === 'bot' 
                ? `<div class="avatar bot"><i class="bi bi-robot"></i></div>`
                : user.pic 
                    ? `<div class="avatar user-av"><img src="${user.pic}"></div>`
                    : `<div class="avatar bot"><i class="bi bi-person"></i></div>`;

            // Show time only for bot messages
            const timeHtml = (type === 'bot' && timeSec) 
                ? `<div class="msg-time">TimeTaken: ${timeSec}s</div>` 
                : '';

            row.innerHTML = `
                ${av}
                <div class="msg-content">
                    <div class="msg-name">${type === 'bot' ? 'FindCare AI' : user.name}</div>
                    <div class="bubble">${text}</div>
                    ${timeHtml}
                </div>
            `;
            messages.appendChild(row);
            messages.scrollTop = messages.scrollHeight;
        }

        function playAudio(blob) {
            const url = URL.createObjectURL(blob);
            audio.src = url;
            audio.play();
            audio.onended = () => {
                URL.revokeObjectURL(url);
                if (!forwarded) status.textContent = 'Tap to speak';
            };
        }

        function updateUI() {
            if (recording) {
                micBtn.classList.add('recording');
                micBtn.classList.remove('processing');
                micIcon.className = 'bi bi-stop-fill';
                status.textContent = 'Listening...';
            } else if (processing) {
                micBtn.classList.remove('recording');
                micBtn.classList.add('processing');
                micIcon.className = 'bi bi-hourglass-split';
                status.textContent = 'Processing...';
                micBtn.disabled = true;
            } else {
                micBtn.classList.remove('recording', 'processing');
                micIcon.className = 'bi bi-mic-fill';
                status.textContent = 'Tap to speak';
                micBtn.disabled = false;
            }
        }

        function showErr(msg) {
            document.getElementById('toastMsg').textContent = msg;
            toast.show();
        }

        async function init() {
            try {
                const res = await fetch(`${API}/api/auth/user`, { credentials: 'include' });
                if (!res.ok) { location.href = 'index.html'; return; }

                const u = await res.json();
                user = { name: u.name || 'You', pic: u.picture };
                document.getElementById('userName').textContent = u.name || 'User';
                
                if (u.picture) {
                    const img = document.getElementById('userPic');
                    img.src = u.picture;
                    img.style.display = 'block';
                }

                // Load intro audio (same voice as TTS responses)
                await loadIntroAudio();
                
                await initMic();
            } catch (e) {
                location.href = 'index.html';
            }
        }

        document.getElementById('logoutBtn').onclick = () => location.href = `${API}/logout`;
        init();
    </script>
</body>
</html>
